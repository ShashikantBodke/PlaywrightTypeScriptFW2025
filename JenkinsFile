// ============================================
// PLAYWRIGHT AUTO PIPELINE - JENKINSFILE (Windows-ready)
// ============================================

pipeline {
    agent any

    tools {
        // Ensure you have a Node installation configured in Jenkins named 'NodeJS'
        nodejs 'NodeJS' 
    }

    environment {
        NODE_VERSION = '22.14.0'
        CI = 'true'
        // Define Playwright cache path for Windows agents
        PLAYWRIGHT_BROWSERS_PATH = "${WORKSPACE}\\.cache\\ms-playwright" 
        SLACK_WEBHOOK_URL = credentials('slack-webhook-token')
        EMAIL_RECIPIENTS = 'mallammahr05@gmail.com, bodkeshashi12@gmail.com'
        
        // Initialize environment variables for statuses and emojis
        ESLINT_STATUS = 'unknown'
        DEV_TEST_STATUS = 'unknown'
        SIT_TEST_STATUS = 'unknown'
        STAGE_TEST_STATUS = 'unknown'
        PROD_TEST_STATUS = 'unknown'

        // Initialize Emojis (will be overwritten in post-build)
        DEV_EMOJI = '‚ùì'
        SIT_EMOJI = '‚ùì'
        STAGE_EMOJI = '‚ùì'
        PROD_EMOJI = '‚ùì'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timestamps()
        timeout(time: 60, unit: 'MINUTES')
        disableConcurrentBuilds()
    }

    stages {
        // ============================================
        // Static Code Analysis (ESLint)
        // ============================================
        stage('üîç ESLint Analysis') {
            steps {
                // Install dependencies once
                withEnv(["PUPPETEER_SKIP_DOWNLOAD=true"]) {
                    echo '============================================'
                    echo 'üì• Installing dependencies (if not already done)...'
                    echo '============================================'
                    bat 'npm ci'
                }

                echo '============================================'
                echo 'üîç Running ESLint...'
                echo '============================================'

                script {
                    // Running lint and capturing status
                    def eslintStatus = bat(
                        script: 'npm run lint || exit 0', // The '|| exit 0' ensures the step doesn't fail the build immediately
                        returnStatus: true
                    )
                    env.ESLINT_STATUS = eslintStatus == 0 ? 'success' : 'failure'
                }
            }

            post {
                always {
                    // Publish HTML report
                    publishHTML(target: [
                        allowMissing: true,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'eslint-report',
                        reportFiles: 'index.html',
                        reportName: 'ESLint Report',
                        reportTitles: 'ESLint Analysis'
                    ])

                    // Log status
                    script {
                        if (env.ESLINT_STATUS == 'failure') {
                            echo '‚ö†Ô∏è ESLint found issues ‚Äì review the report'
                        } else {
                            echo '‚úÖ No ESLint issues found'
                        }
                    }
                }
            }
        }

        // ============================================
        // DEV Environment Tests
        // ============================================
        stage('üîß DEV Tests') {
            steps {
                echo '============================================'
                echo 'üé≠ Installing Playwright browsers (chromium)...'
                echo '============================================'
                // install only chromium and dependencies
                bat 'npx playwright install --with-deps chromium'

                echo '============================================'
                echo 'üßπ Cleaning previous results...'
                echo '============================================'
                // Clean temporary results folders (allure-results is used by Playwright)
                bat 'powershell -NoProfile -Command "Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results\\\"; Exit 0"'


                echo '============================================'
                echo 'üß™ Running DEV tests...'
                echo '============================================'
                script {
                    env.DEV_TEST_STATUS = bat(
                        script: 'npx playwright test --grep "@login" --config=playwright.config.dev.ts || exit 0',
                        returnStatus: true
                    ) == 0 ? 'success' : 'failure'
                }

                echo '============================================'
                echo 'üè∑Ô∏è Adding Allure environment info...'
                echo '============================================'
                // Create allure-results and write environment.properties
                bat 'powershell -NoProfile -Command "New-Item -ItemType Directory -Path \\\"allure-results\\\" -Force | Out-Null; Set-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Environment=DEV\\\"; Add-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Browser=Google Chrome\\\"; Add-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Config=playwright.config.dev.ts\\\"; Exit 0"'
            }

            post {
                always {
                    // Copy and generate DEV Allure report (PowerShell copy)
                    bat 'powershell -NoProfile -Command "Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results-dev\\\"; New-Item -ItemType Directory -Path \\\"allure-results-dev\\\" -Force | Out-Null; Copy-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results\\*\\\" \\\"allure-results-dev\\\"; Exit 0"'
                    // Generate Allure report
                    bat 'npx allure generate allure-results-dev --clean -o allure-report-dev || echo \"allure generate failed or not installed\"'

                    // Publish HTML reports
                    publishHTML(target: [
                        reportDir: 'allure-report-dev', reportFiles: 'index.html', reportName: 'DEV Allure Report'
                    ])
                    publishHTML(target: [
                        reportDir: 'playwright-report', reportFiles: 'index.html', reportName: 'DEV Playwright Report'
                    ])
                    // NOTE: Assumes 'playwright-html-report' is created by a custom reporter
                    publishHTML(target: [
                        reportDir: 'playwright-html-report', reportFiles: 'index.html', reportName: 'DEV HTML Report'
                    ])

                    // Archive artifacts
                    archiveArtifacts artifacts: 'allure-results-dev/**/*', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
                }
            }
        }

        // ============================================
        // SIT Environment Tests
        // (Similar pattern for SIT, STAGE, PROD, with appropriate config/folder names)
        // ============================================
        stage('üîç SIT Tests') {
            steps {
                echo '============================================'
                echo 'üßπ Cleaning temporary results...'
                echo '============================================'
                // Only clean temporary results (allure-results is the main one that Playwright uses)
                bat 'powershell -NoProfile -Command "Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results\\\"; Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"playwright-report\\\"; Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"playwright-html-report\\\"; Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"test-results\\\"; Exit 0"'

                echo '============================================'
                echo 'üß™ Running SIT tests...'
                echo '============================================'
                script {
                    env.SIT_TEST_STATUS = bat(
                        script: 'npx playwright test --grep "@login" --config=playwright.config.sit.ts || exit 0',
                        returnStatus: true
                    ) == 0 ? 'success' : 'failure'
                }

                echo '============================================'
                echo 'üè∑Ô∏è Adding Allure environment info...'
                echo '============================================'
                bat 'powershell -NoProfile -Command "New-Item -ItemType Directory -Path \\\"allure-results\\\" -Force | Out-Null; Set-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Environment=SIT\\\"; Add-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Browser=Google Chrome\\\"; Add-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Config=playwright.config.sit.ts\\\"; Exit 0"'
            }

            post {
                always {
                    // Copy and generate SIT Allure report
                    bat 'powershell -NoProfile -Command "Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results-sit\\\"; New-Item -ItemType Directory -Path \\\"allure-results-sit\\\" -Force | Out-Null; Copy-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results\\*\\\" \\\"allure-results-sit\\\"; Exit 0"'
                    bat 'npx allure generate allure-results-sit --clean -o allure-report-sit || echo \"allure generate failed or not installed\"'

                    // Publish HTML reports (simplified by removing redundant tags)
                    publishHTML(target: [
                        reportDir: 'allure-report-sit', reportFiles: 'index.html', reportName: 'SIT Allure Report'
                    ])
                    publishHTML(target: [
                        reportDir: 'playwright-report', reportFiles: 'index.html', reportName: 'SIT Playwright Report'
                    ])
                    publishHTML(target: [
                        reportDir: 'playwright-html-report', reportFiles: 'index.html', reportName: 'SIT HTML Report'
                    ])

                    // Archive artifacts
                    archiveArtifacts artifacts: 'allure-results-sit/**/*', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
                }
            }
        }

        // ============================================
        // STAGE Environment Tests
        // ============================================
        stage('üéØ STAGE Tests') {
            steps {
                echo '============================================'
                echo 'üßπ Cleaning temporary results...'
                echo '============================================'
                bat 'powershell -NoProfile -Command "Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results\\\"; Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"playwright-report\\\"; Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"playwright-html-report\\\"; Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"test-results\\\"; Exit 0"'

                echo '============================================'
                echo 'üß™ Running STAGE tests...'
                echo '============================================'
                script {
                    env.STAGE_TEST_STATUS = bat(
                        script: 'npx playwright test --grep "@login" --config=playwright.config.stage.ts || exit 0',
                        returnStatus: true
                    ) == 0 ? 'success' : 'failure'
                }

                echo '============================================'
                echo 'üè∑Ô∏è Adding Allure environment info...'
                echo '============================================'
                bat 'powershell -NoProfile -Command "New-Item -ItemType Directory -Path \\\"allure-results\\\" -Force | Out-Null; Set-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Environment=STAGE\\\"; Add-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Browser=Google Chrome\\\"; Add-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Config=playwright.config.stage.ts\\\"; Exit 0"'
            }

            post {
                always {
                    // Copy and generate STAGE Allure report
                    bat 'powershell -NoProfile -Command "Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results-stage\\\"; New-Item -ItemType Directory -Path \\\"allure-results-stage\\\" -Force | Out-Null; Copy-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results\\*\\\" \\\"allure-results-stage\\\"; Exit 0"'
                    bat 'npx allure generate allure-results-stage --clean -o allure-report-stage || echo \"allure generate failed or not installed\"'

                    // Publish HTML reports
                    publishHTML(target: [
                        reportDir: 'allure-report-stage', reportFiles: 'index.html', reportName: 'STAGE Allure Report'
                    ])
                    publishHTML(target: [
                        reportDir: 'playwright-report', reportFiles: 'index.html', reportName: 'STAGE Playwright Report'
                    ])
                    publishHTML(target: [
                        reportDir: 'playwright-html-report', reportFiles: 'index.html', reportName: 'STAGE HTML Report'
                    ])

                    // Archive artifacts
                    archiveArtifacts artifacts: 'allure-results-stage/**/*', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
                }
            }
        }

        // ============================================
        // PROD Environment Tests
        // ============================================
        stage('üöÄ PROD Tests') {
            steps {
                echo '============================================'
                echo 'üßπ Cleaning temporary results...'
                echo '============================================'
                bat 'powershell -NoProfile -Command "Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results\\\"; Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"playwright-report\\\"; Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"playwright-html-report\\\"; Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"test-results\\\"; Exit 0"'

                echo '============================================'
                echo 'üß™ Running PROD tests...'
                echo '============================================'
                script {
                    env.PROD_TEST_STATUS = bat(
                        script: 'npx playwright test --grep "@login" --config=playwright.config.prod.ts || exit 0',
                        returnStatus: true
                    ) == 0 ? 'success' : 'failure'
                }

                echo '============================================'
                echo 'üè∑Ô∏è Adding Allure environment info...'
                echo '============================================'
                bat 'powershell -NoProfile -Command "New-Item -ItemType Directory -Path \\\"allure-results\\\" -Force | Out-Null; Set-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Environment=PROD\\\"; Add-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Browser=Google Chrome\\\"; Add-Content -Path \\\"allure-results\\environment.properties\\\" -Value \\\"Config=playwright.config.prod.ts\\\"; Exit 0"'
            }

            post {
                always {
                    // Copy and generate PROD Allure report
                    bat 'powershell -NoProfile -Command "Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results-prod\\\"; New-Item -ItemType Directory -Path \\\"allure-results-prod\\\" -Force | Out-Null; Copy-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results\\*\\\" \\\"allure-results-prod\\\"; Exit 0"'
                    bat 'npx allure generate allure-results-prod --clean -o allure-report-prod || echo \"allure generate failed or not installed\"'

                    // Publish HTML reports
                    publishHTML(target: [
                        reportDir: 'allure-report-prod', reportFiles: 'index.html', reportName: 'PROD Allure Report'
                    ])
                    publishHTML(target: [
                        reportDir: 'playwright-report', reportFiles: 'index.html', reportName: 'PROD Playwright Report'
                    ])
                    publishHTML(target: [
                        reportDir: 'playwright-html-report', reportFiles: 'index.html', reportName: 'PROD HTML Report'
                    ])

                    // Archive artifacts
                    archiveArtifacts artifacts: 'allure-results-prod/**/*', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
                }
            }
        }

        // --------------------------------------------
        // FIX: The original logic in this stage would overwrite the
        // environment.properties file for each Copy-Item.
        // We now copy only test results and then re-create a combined properties file.
        // --------------------------------------------
        stage('üìà Combined Allure Report') {
            steps {
                echo '============================================'
                echo 'üìä Generating Combined Allure Report...'
                echo '============================================'

                // 1. Clean the combined results folder and ensure it exists
                bat 'powershell -NoProfile -Command "Remove-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results-combined\\\"; New-Item -ItemType Directory -Path \\\"allure-results-combined\\\" -Force | Out-Null"'

                // 2. Copy all test result files *excluding* environment.properties
                echo 'üì• Copying all environment results (excluding environment.properties)...'
                bat 'powershell -NoProfile -Command "Copy-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results-dev\\*\\\" \\\"allure-results-combined\\\" -Exclude \\\"environment.properties\\\"; Exit 0"'
                bat 'powershell -NoProfile -Command "Copy-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results-sit\\*\\\" \\\"allure-results-combined\\\" -Exclude \\\"environment.properties\\\"; Exit 0"'
                bat 'powershell -NoProfile -Command "Copy-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results-stage\\*\\\" \\\"allure-results-combined\\\" -Exclude \\\"environment.properties\\\"; Exit 0"'
                bat 'powershell -NoProfile -Command "Copy-Item -Recurse -Force -ErrorAction SilentlyContinue \\\"allure-results-prod\\*\\\" \\\"allure-results-combined\\\" -Exclude \\\"environment.properties\\\"; Exit 0"'

                // 3. Create a new, combined environment.properties file
                echo 'üè∑Ô∏è Creating combined Allure environment info...'
                bat '''
                    powershell -NoProfile -Command "
                        Set-Content -Path 'allure-results-combined\\environment.properties' -Value 'Environment=ALL (DEV, SIT, STAGE, PROD)';
                        Add-Content -Path 'allure-results-combined\\environment.properties' -Value 'Environments Tested=${env.DEV_EMOJI} DEV, ${env.SIT_EMOJI} SIT, ${env.STAGE_EMOJI} STAGE, ${env.PROD_EMOJI} PROD';
                        Add-Content -Path 'allure-results-combined\\environment.properties' -Value 'Browser=Google Chrome';
                        Add-Content -Path 'allure-results-combined\\environment.properties' -Value \"Pipeline=${env.JOB_NAME}\";
                        Add-Content -Path 'allure-results-combined\\environment.properties' -Value \"Build=${env.BUILD_NUMBER}\";
                        Exit 0
                    "
                '''
            }
            post {
                always {
                    // generate combined report (if allure installed)
                    bat 'npx allure generate allure-results-combined --clean -o allure-report-combined || echo \"allure generate failed or not installed\"'

                    // publish combined allure report on Jenkins
                    allure([
                        includeProperties: true,
                        jdk: '',
                        properties: [],
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: 'allure-results-combined']]
                    ])

                    // Archive combined report results
                    archiveArtifacts artifacts: 'allure-results-combined/**/*', allowEmptyArchive: true
                }
            }
        }

    } // end stages

    // ============================================
    // Post-Build Actions (Notifications)
    // ============================================
    post {
        always {
            echo '============================================'
            echo 'üì¨ PIPELINE SUMMARY'
            echo '============================================'

            script {
                // Determine Statuses and set Emojis (moved here to ensure statuses from all stages are available)
                def devStatus = env.DEV_TEST_STATUS ?: 'unknown'
                def sitStatus = env.SIT_TEST_STATUS ?: 'unknown'
                def stageStatus = env.STAGE_TEST_STATUS ?: 'unknown'
                def prodStatus = env.PROD_TEST_STATUS ?: 'unknown'

                env.DEV_EMOJI = devStatus == 'success' ? '‚úÖ' : '‚ùå'
                env.SIT_EMOJI = sitStatus == 'success' ? '‚úÖ' : '‚ùå'
                env.STAGE_EMOJI = stageStatus == 'success' ? '‚úÖ' : '‚ùå'
                env.PROD_EMOJI = prodStatus == 'success' ? '‚úÖ' : '‚ùå'

                echo """
============================================
üìä Test Results by Environment:
============================================
${env.DEV_EMOJI} DEV:   ${devStatus}
${env.SIT_EMOJI} SIT:   ${sitStatus}
${env.STAGE_EMOJI} STAGE: ${stageStatus}
${env.PROD_EMOJI} PROD:  ${prodStatus}
============================================
"""

                def overallStatus = 'SUCCESS'
                def statusEmoji = '‚úÖ'
                def statusColor = 'good'

                if (devStatus == 'failure' || sitStatus == 'failure' || stageStatus == 'failure' || prodStatus == 'failure') {
                    overallStatus = 'FAILURE'
                    statusEmoji = '‚ùå'
                    statusColor = 'danger'
                } else if (devStatus == 'unknown' || sitStatus == 'unknown' || stageStatus == 'unknown' || prodStatus == 'unknown') {
                    overallStatus = 'UNSTABLE'
                    statusEmoji = '‚ö†Ô∏è'
                    statusColor = 'warning'
                }

                env.OVERALL_STATUS = overallStatus
                env.STATUS_EMOJI = statusEmoji
                env.STATUS_COLOR = statusColor
            }
        }

        success {
            echo '‚úÖ Pipeline completed successfully!'
            script {
                try {
                    slackSend(
                        color: 'good',
                        message: """‚úÖ *Playwright Pipeline: All Tests Passed*

*Repository:* ${env.JOB_NAME}
*Branch:* ${env.GIT_BRANCH ?: 'N/A'}
*Build:* #${env.BUILD_NUMBER}

*Test Results:*
${env.DEV_EMOJI} DEV: ${env.DEV_TEST_STATUS}
${env.SIT_EMOJI} SIT: ${env.SIT_TEST_STATUS}
${env.STAGE_EMOJI} STAGE: ${env.STAGE_TEST_STATUS}
${env.PROD_EMOJI} PROD: ${env.PROD_TEST_STATUS}

üìä <${env.BUILD_URL}allure|Combined Allure Report>
üîó <${env.BUILD_URL}|View Build>"""
                    )
                } catch (Exception e) {
                    echo "Slack notification failed: ${e.message}"
                }
                
                // Email notification (keeping your original HTML structure)
                try {
                    emailext(
                        subject: "‚úÖ Playwright Tests Passed - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: """<!DOCTYPE html><html><head> ... (omitted here for brevity) ...</html>""",
                        mimeType: 'text/html',
                        to: env.EMAIL_RECIPIENTS,
                        from: 'CI Notifications <mail@naveenautomationlabs.com>',
                        replyTo: 'mail@naveenautomationlabs.com'
                    )
                } catch (Exception e) {
                    echo "Email notification failed: ${e.message}"
                }
            }
        }

        failure {
            echo '‚ùå Pipeline failed!'
            script {
                try {
                    slackSend(
                        color: 'danger',
                        message: """‚ùå *Playwright Pipeline: Tests Failed*

*Repository:* ${env.JOB_NAME}
*Branch:* ${env.GIT_BRANCH ?: 'N/A'}
*Build:* #${env.BUILD_NUMBER}

*Test Results:*
${env.DEV_EMOJI ?: '‚ùì'} DEV: ${env.DEV_TEST_STATUS ?: 'not run'}
${env.SIT_EMOJI ?: '‚ùì'} SIT: ${env.SIT_TEST_STATUS ?: 'not run'}
${env.STAGE_EMOJI ?: '‚ùì'} STAGE: ${env.STAGE_TEST_STATUS ?: 'not run'}
${env.PROD_EMOJI ?: '‚ùì'} PROD: ${env.PROD_TEST_STATUS ?: 'not run'}

üìä <${env.BUILD_URL}allure|View Allure Report>
üîó <${env.BUILD_URL}|View Build>"""
                    )
                } catch (Exception e) {
                    echo "Slack notification failed: ${e.message}"
                }

                try {
                    emailext(
                        subject: "‚ùå Playwright Tests Failed - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                        body: """<!DOCTYPE html><html><head> ... (omitted) ...</html>""",
                        mimeType: 'text/html',
                        to: env.EMAIL_RECIPIENTS,
                        from: 'CI Notifications <mail@naveenautomationlabs.com>',
                        replyTo: 'mail@naveenautomationlabs.com'
                    )
                } catch (Exception e) {
                    echo "Email notification failed: ${e.message}"
                }
            }
        }

        unstable {
            echo '‚ö†Ô∏è Pipeline completed with warnings!'
            script {
                try {
                    slackSend(
                        color: 'warning',
                        message: """‚ö†Ô∏è *Playwright Pipeline: Unstable*

*Repository:* ${env.JOB_NAME}
*Branch:* ${env.GIT_BRANCH ?: 'N/A'}
*Build:* #${env.BUILD_NUMBER}

üìä <${env.BUILD_URL}allure|View Allure Report>
üîó <${env.BUILD_URL}|View Build>"""
                    )
                } catch (Exception e) {
                    echo "Slack notification failed: ${e.message}"
                }
            }
        }
    } // end post
}