// ============================================
// PLAYWRIGHT AUTO PIPELINE - JENKINSFILE (Windows Optimized)
// ============================================
// Flow: lint â†’ dev â†’ sit â†’ stage â†’ prod (automatic)
// Trigger: Push, PR, or manual build
// Reports: Separate Allure per environment, Playwright HTML, Custom HTML
// âœ… ESLint static code analysis
// âœ… Separate Allure reports per environment
// âœ… Slack notifications for test results
// âœ… Email notifications with all report links
// ============================================
//
// Required Jenkins Credentials:
// ------------------------------------
// slack-token Â  Â  Â  Â  Â - Slack Webhook Token (Secret text)
// ============================================
//
// Required Jenkins Plugins:
// ------------------------------------
// - NodeJS Plugin
// - Allure Jenkins Plugin
// - HTML Publisher Plugin
// - Slack Notification Plugin
// - Email Extension Plugin
// - Pipeline Stage View Plugin
// ============================================

pipeline {
Â  Â  agent any

Â  Â  tools {
Â  Â  Â  Â  nodejs 'NodeJS'
Â  Â  }

Â  Â  environment {
Â  Â  Â  Â  NODE_VERSION = '22.14.0'
Â  Â  Â  Â  CI = 'true'
Â  Â  Â  Â  PLAYWRIGHT_BROWSERS_PATH = "${WORKSPACE}/.cache/ms-playwright"
Â  Â  Â  Â  SLACK_WEBHOOK_URL = credentials('slack-webhook-token')
Â  Â  Â  Â  // Email recipients - update these with your actual email addresses
Â  Â  Â  Â  EMAIL_RECIPIENTS = 'bodkeshashi12@gmail.com, mallammahr05@gmail.com'
Â  Â  }

Â  Â  options {
Â  Â  Â  Â  buildDiscarder(logRotator(numToKeepStr: '20'))
Â  Â  Â  Â  timestamps()
Â  Â  Â  Â  timeout(time: 60, unit: 'MINUTES')
Â  Â  Â  Â  disableConcurrentBuilds()
Â  Â  }

Â  Â  stages {
Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  // Static Code Analysis (ESLint) Â 
Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  stage('ðŸ” ESLint Analysis') {
Â  Â  Â  Â  Â  Â  steps {
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ“¥ Installing dependencies...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  bat 'npm ci'

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ“ Creating ESLint report directory...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  bat 'mkdir eslint-report' // Changed mkdir -p to simpler Windows mkdir

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ” Running ESLint...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  script {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  def eslintStatus = bat(script: 'npm run lint', returnStatus: true)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  env.ESLINT_STATUS = eslintStatus == 0 ? 'success' : 'failure'
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ“Š Generating ESLint HTML Report...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  bat 'npm run lint:report || true'
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  post {
Â  Â  Â  Â  Â  Â  Â  Â  always {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'eslint-report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'ESLint Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'ESLint Analysis'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  script {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (env.ESLINT_STATUS == 'failure') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo 'âš ï¸ ESLint found issues - check the HTML report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo 'âœ… No ESLint issues found'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  // DEV Environment Tests
Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  stage('ðŸ”§ DEV Tests') {
Â  Â  Â  Â  Â  Â  steps {
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸŽ­ Installing Playwright browsers...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  bat 'npx playwright install --with-deps chromium'

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ§¹ Cleaning previous results...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  // WINDOWS OPTIMIZED CLEANUP (PowerShell)
Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  powershell -Command "Remove-Item -Path allure-results, playwright-report, playwright-html-report, test-results -Recurse -Force -ErrorAction SilentlyContinue"
Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ§ª Running DEV tests...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  script {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  env.DEV_TEST_STATUS = bat(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  script: 'npx playwright test --grep "@login" --config=playwright.config.dev.ts',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  returnStatus: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ) == 0 ? 'success' : 'failure'
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ·ï¸ Adding Allure environment info...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mkdir allure-results
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Environment=DEV > allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Browser=Google Chrome >> allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Config=playwright.config.dev.ts >> allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  '''
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  post {
Â  Â  Â  Â  Â  Â  Â  Â  always {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Copy and generate DEV Allure Report
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Using COPY command instead of cp -r
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mkdir allure-results-dev
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  robocopy allure-results allure-results-dev /E /NJH /NJS /NFL /NDL /NC /NS /NP || REM Ignore robocopy failure if source is empty
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  npx allure generate allure-results-dev --clean -o allure-report-dev || true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Publish DEV Allure HTML Report
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'allure-report-dev',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'DEV Allure Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'DEV Allure Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'playwright-report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'DEV Playwright Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'DEV Playwright Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'playwright-html-report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'DEV HTML Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'DEV Custom HTML Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  archiveArtifacts artifacts: 'allure-results-dev/**/*', allowEmptyArchive: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  // SIT Environment Tests
Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  stage('ðŸ” SIT Tests') {
Â  Â  Â  Â  Â  Â  steps {
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ§¹ Cleaning previous results...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  // WINDOWS OPTIMIZED CLEANUP (PowerShell)
Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  powershell -Command "Remove-Item -Path allure-results, playwright-report, playwright-html-report, test-results -Recurse -Force -ErrorAction SilentlyContinue"
Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ§ª Running SIT tests...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  script {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  env.ST_TEST_STATUS = bat(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  script: 'npx playwright test --grep "@login" --config=playwright.config.sit.ts',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  returnStatus: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ) == 0 ? 'success' : 'failure'
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ·ï¸ Adding Allure environment info...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mkdir allure-results
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Environment=SIT > allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Browser=Google Chrome >> allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Config=playwright.config.sit.ts >> allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  '''
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  post {
Â  Â  Â  Â  Â  Â  Â  Â  always {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Copy and generate SIT Allure Report
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Using COPY command instead of cp -r
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mkdir allure-results-sit
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  robocopy allure-results allure-results-sit /E /NJH /NJS /NFL /NDL /NC /NS /NP || REM Ignore robocopy failure if source is empty
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  npx allure generate allure-results-sit --clean -o allure-report-sit || true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Publish sit Allure HTML Report
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'allure-report-sit',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'SIT Allure Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'SIT Allure Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'playwright-report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'SIT Playwright Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'SIT Playwright Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'playwright-html-report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'SIT HTML Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'SIT Custom HTML Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  archiveArtifacts artifacts: 'allure-results-sit/**/*', allowEmptyArchive: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  // STAGE Environment Tests
Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  stage('ðŸŽ¯ STAGE Tests') {
Â  Â  Â  Â  Â  Â  steps {
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ§¹ Cleaning previous results...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  // WINDOWS OPTIMIZED CLEANUP (PowerShell)
Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  powershell -Command "Remove-Item -Path allure-results, playwright-report, playwright-html-report, test-results -Recurse -Force -ErrorAction SilentlyContinue"
Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ§ª Running STAGE tests...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  script {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  env.STAGE_TEST_STATUS = bat(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  script: 'npx playwright test --grep "@login" --config=playwright.config.stage.ts',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  returnStatus: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ) == 0 ? 'success' : 'failure'
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ·ï¸ Adding Allure environment info...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mkdir allure-results
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Environment=STAGE > allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Browser=Google Chrome >> allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Config=playwright.config.stage.ts >> allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  '''
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  post {
Â  Â  Â  Â  Â  Â  Â  Â  always {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Copy and generate STAGE Allure Report
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Using COPY command instead of cp -r
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mkdir allure-results-stage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  robocopy allure-results allure-results-stage /E /NJH /NJS /NFL /NDL /NC /NS /NP || REM Ignore robocopy failure if source is empty
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  npx allure generate allure-results-stage --clean -o allure-report-stage || true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Publish STAGE Allure HTML Report
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'allure-report-stage',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'STAGE Allure Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'STAGE Allure Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'playwright-report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'STAGE Playwright Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'STAGE Playwright Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'playwright-html-report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'STAGE HTML Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'STAGE Custom HTML Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  archiveArtifacts artifacts: 'allure-results-stage/**/*', allowEmptyArchive: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  // PROD Environment Tests
Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  stage('ðŸš€ PROD Tests') {
Â  Â  Â  Â  Â  Â  steps {
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ§¹ Cleaning previous results...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  // WINDOWS OPTIMIZED CLEANUP (PowerShell)
Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  powershell -Command "Remove-Item -Path allure-results, playwright-report, playwright-html-report, test-results -Recurse -Force -ErrorAction SilentlyContinue"
Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ§ª Running PROD tests...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  script {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  env.PROD_TEST_STATUS = bat(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  script: 'npx playwright test --grep "@login" --config=playwright.config.prod.ts',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  returnStatus: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ) == 0 ? 'success' : 'failure'
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ·ï¸ Adding Allure environment info...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mkdir allure-results
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Environment=PROD > allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Browser=Google Chrome >> allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Config=playwright.config.prod.ts >> allure-results/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  '''
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  post {
Â  Â  Â  Â  Â  Â  Â  Â  always {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Copy and generate PROD Allure Report
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Using COPY command instead of cp -r
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mkdir allure-results-prod
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  robocopy allure-results allure-results-prod /E /NJH /NJS /NFL /NDL /NC /NS /NP || REM Ignore robocopy failure if source is empty
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  npx allure generate allure-results-prod --clean -o allure-report-prod || true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '''

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Publish PROD Allure HTML Report
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'allure-report-prod',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'PROD Allure Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'PROD Allure Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'playwright-report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'PROD Playwright Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'PROD Playwright Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  publishHTML(target: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowMissing: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alwaysLinkToLastBuild: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepAll: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportDir: 'playwright-html-report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportFiles: 'index.html',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportName: 'PROD HTML Report',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportTitles: 'PROD Custom HTML Report'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  archiveArtifacts artifacts: 'allure-results-prod/**/*', allowEmptyArchive: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  // Generate Combined Allure Report (All Environments)
Â  Â  Â  Â  // ============================================
Â  Â  Â  Â  stage('ðŸ“ˆ Combined Allure Report') {
Â  Â  Â  Â  Â  Â  steps {
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'
Â  Â  Â  Â  Â  Â  Â  Â  echo 'ðŸ“Š Generating Combined Allure Report...'
Â  Â  Â  Â  Â  Â  Â  Â  echo '============================================'

Â  Â  Â  Â  Â  Â  Â  Â  // Use robust Windows file copy (Robocopy is highly recommended)
Â  Â  Â  Â  Â  Â  Â  Â  bat '''
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # Create combined results directory
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mkdir allure-results-combined
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # Copy all environment results (Robocopy for Windows recursive copy)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  robocopy allure-results-dev allure-results-combined /E /NJH /NJS /NFL /NDL /NC /NS /NP || REM
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  robocopy allure-results-sit allure-results-combined /E /NJH /NJS /NFL /NDL /NC /NS /NP || REM
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  robocopy allure-results-stage allure-results-combined /E /NJH /NJS /NFL /NDL /NC /NS /NP || REM
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  robocopy allure-results-prod allure-results-combined /E /NJH /NJS /NFL /NDL /NC /NS /NP || REM
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # Create combined environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Environment=ALL (DEV, SIT, STAGE, PROD) > allure-results-combined/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Browser=Google Chrome >> allure-results-combined/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Pipeline=${JOB_NAME} >> allure-results-combined/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  echo Build=${BUILD_NUMBER} >> allure-results-combined/environment.properties
Â  Â  Â  Â  Â  Â  Â  Â  '''
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  post {
Â  Â  Â  Â  Â  Â  Â  Â  always {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Generate Combined Allure Report using Allure Jenkins Plugin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allure([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  includeProperties: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  jdk: '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  properties: [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reportBuildPolicy: 'ALWAYS',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  results: [[path: 'allure-results-combined']]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ])
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }